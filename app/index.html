<!DOCTYPE html>
<html>
<head>
  <title>METACPAN.js</title>
  <script src="/handlebars-v3.0.0.js"></script>
  <script src="/metacpan.js"></script>

<script id="release-template" type="text/x-handlebars-template">
  <div class="entry">
    <h2>{{author}} {{name}} {{date}}</h2>
  </div>
  <div class="repository">
    <a href="{{resources.repository.web}}">{{resources.repository.type}}</a>
  </div>
</script>

<script id="recent-template" type="text/x-handlebars-template">
  <ul>
    {{#each hits.hits}}
      <li><a href="#" class="release" data-distribution="{{fields.distribution}}">{{fields.name}}</a><br>{{fields.abstract}}<br>{{fields.date}}</li>
    {{/each}}
  </ul>
</script>


</head>
<body>

<a href="#" id="recent">recent</a>

<p>Find a solution in Perl</p>
<p><input type="text" id="query"><button id="search">Search</button></p>
<hr>

<div id="result">
</div>

</body>
</html>

<script>
function search() {
	var query = document.getElementById('query').value;
	metacpan.release(query, display_result);
}


function display_result(query, result) {
	display(query, result, 'release-template');
};

function display(query, result, template) {
    var source   = document.getElementById(template).innerHTML;
    var template = Handlebars.compile(source);
    //var context = {name: result["name"]};
    //var html    = template(context);
    var html    = template(result);
    document.getElementById('result').innerHTML = html;

	var as = document.getElementsByClassName('release');
    for (i=0; i<as.length; i++) {
		as[i].addEventListener('click', function() {
			//var query = this.innerHTML;
			var query = this.getAttribute('data-distribution');
			//console.log(query);
			metacpan.release(query, display_result);
		});
	}
}

function display_recent(count, result) {
	display(count, result, 'recent-template');
}

//document.getElementById('query').addEventListener('keyup', search);
document.getElementById('search').addEventListener('click', search);

document.getElementById('recent').addEventListener('click', function() {
	metacpan.recent(20, display_recent);
});
</script>
